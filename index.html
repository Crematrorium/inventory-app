import React, { useState, useEffect, useRef } from 'react';

const App = () => {
  // Состояния приложения
  const [currentScreen, setCurrentScreen] = useState('main');
  const [inventoryType, setInventoryType] = useState('location');
  const [selectedWarehouse, setSelectedWarehouse] = useState('ТВЗ');
  const [serverIp, setServerIp] = useState('10.7.0.78');
  const [serverPort, setServerPort] = useState('8765');
  const [useSecureProtocol, setUseSecureProtocol] = useState(false);
  const [connectionStatus, setConnectionStatus] = useState('disconnected');
  const [scannedItems, setScannedItems] = useState([]);
  const [currentProduct, setCurrentProduct] = useState(null);
  const [quantity, setQuantity] = useState(1);
  const [isInEditMode, setIsInEditMode] = useState(false);
  const [activeTab, setActiveTab] = useState('scan');
  const [showHttpsWarning, setShowHttpsWarning] = useState(false);
  const [compatibilityResults, setCompatibilityResults] = useState([]);
  const [debugMessage, setDebugMessage] = useState('Готов к работе');

  // Рефы для DOM элементов
  const barcodeInputRef = useRef(null);
  const wsRef = useRef(null);
  const reconnectAttemptsRef = useRef(0);
  const MAX_RECONNECT_ATTEMPTS = 10;
  const RECONNECT_DELAYS = [1000, 2000, 3000, 5000, 8000, 13000, 21000, 34000, 55000, 89000];

  // Демо-данные номенклатуры
  const nomenclature = [
    { id: 1, code: '100001', barcode: '4601234567890', name: 'Смартфон Samsung Galaxy S21', stock: { 'ТВЗ': 50, 'Электромаркет': 25 }, reserved: 5, location: 'Секция A-1' },
    { id: 2, code: '100002', barcode: '4601234567891', name: 'Ноутбук Lenovo IdeaPad 5', stock: { 'ТВЗ': 30, 'Электромаркет': 15 }, reserved: 3, location: 'Секция B-2' },
    { id: 3, code: '100003', barcode: '4601234567892', name: 'Наушники Sony WH-1000XM4', stock: { 'ТВЗ': 20, 'Электромаркет': 10 }, reserved: 2, location: 'Секция C-3' },
    { id: 4, code: '100004', barcode: '4601234567893', name: 'Планшет Apple iPad Air', stock: { 'ТВЗ': 15, 'Электромаркет': 8 }, reserved: 1, location: 'Секция D-4' },
    { id: 5, code: '100005', barcode: '4601234567894', name: 'Умные часы Apple Watch Series 7', stock: { 'ТВЗ': 25, 'Электромаркет': 12 }, reserved: 4, location: 'Секция E-5' }
  ];

  // Функция для отладки
  const debugLog = (message) => {
    const timestamp = new Date().toISOString().slice(11, 23);
    const fullMessage = `[${timestamp}] ${message}`;
    setDebugMessage(fullMessage);
    console.log(fullMessage);
  };

  // Обновление статуса подключения
  const updateConnectionStatus = (status) => {
    setConnectionStatus(status);
  };

  // Подключение к WebSocket
  const connectWebSocket = () => {
    if (!serverIp) {
      debugLog('Отмена подключения: IP не указан');
      return;
    }

    const protocol = useSecureProtocol ? 'wss' : 'ws';
    const wsUrl = `${protocol}://${serverIp}:${serverPort}`;
    debugLog(`Попытка подключения к WebSocket: ${wsUrl}`);
    updateConnectionStatus('connecting');

    try {
      const ws = new WebSocket(wsUrl);
      wsRef.current = ws;

      ws.onopen = () => {
        reconnectAttemptsRef.current = 0;
        debugLog('WebSocket соединение установлено');
        showNotification('Подключено к серверу');
        updateConnectionStatus('connected');
      };

      ws.onmessage = (event) => {
        debugLog(`Получено сообщение от сервера: ${event.data}`);
      };

      ws.onerror = (error) => {
        debugLog(`Ошибка WebSocket: ${error.message}`);
        showNotification('Ошибка подключения к серверу');
        updateConnectionStatus('disconnected');
      };

      ws.onclose = (event) => {
        debugLog(`WebSocket закрыт. Код: ${event.code}, причина: ${event.reason}`);
        updateConnectionStatus('disconnected');
        if (reconnectAttemptsRef.current < MAX_RECONNECT_ATTEMPTS) {
          const delay = RECONNECT_DELAYS[reconnectAttemptsRef.current] || 5000;
          reconnectAttemptsRef.current++;
          debugLog(`Попытка переподключения (${reconnectAttemptsRef.current}/${MAX_RECONNECT_ATTEMPTS}) через ${delay}ms`);
          setTimeout(connectWebSocket, delay);
        } else {
          debugLog('Достигнуто максимальное количество попыток переподключения');
          showNotification('Не удалось подключиться к серверу');
        }
      };
    } catch (e) {
      debugLog(`Ошибка инициализации WebSocket: ${e.message}`);
      showNotification('Ошибка подключения к серверу');
      updateConnectionStatus('disconnected');
    }
  };

  // Тестирование подключения
  const testConnection = () => {
    if (!serverIp) {
      alert('Введите IP-адрес сервера');
      return;
    }

    // Закрыть существующее соединение
    if (wsRef.current) {
      wsRef.current.close();
      wsRef.current = null;
    }

    // Попробовать подключиться
    connectWebSocket();
  };

  // Проверка совместимости
  const testCompatibility = () => {
    const results = [];
    
    if (window.WebSocket) {
      results.push('WebSocket: поддерживается');
    } else {
      results.push('WebSocket: НЕ поддерживается');
    }
    
    if (typeof Array.prototype.find === 'function') {
      results.push('Array.find(): поддерживается');
    } else {
      results.push('Array.find(): НЕ поддерживается');
    }
    
    if (typeof document.body.style.flex !== 'undefined') {
      results.push('Flexbox: поддерживается');
    } else {
      results.push('Flexbox: НЕ поддерживается');
    }
    
    if (window.Promise) {
      results.push('Promise: поддерживается');
    } else {
      results.push('Promise: НЕ поддерживается');
    }

    setCompatibilityResults(results);
    debugLog(`Проверка совместимости завершена: ${results.length} тестов`);
  };

  // Начало инвентаризации
  const startInventory = () => {
    debugLog('Нажата кнопка "Начать инвентаризацию"');
    setCurrentScreen('scan');
    setTimeout(() => {
      if (barcodeInputRef.current) {
        barcodeInputRef.current.focus();
      }
    }, 100);
  };

  // Возврат на главный экран
  const backToMain = () => {
    debugLog('Нажата кнопка "Назад"');
    setCurrentScreen('main');
  };

  // Обработка штрих-кода
  const processBarcode = (barcode) => {
    setIsInEditMode(false);
    if (!barcode) return;
    debugLog(`Обработка штрих-кода: ${barcode}`);

    const product = nomenclature.find(p => p.barcode === barcode);
    if (product) {
      setCurrentProduct(product);
      addScannedItem(1);
    } else {
      const newProduct = {
        id: Date.now(),
        barcode: barcode,
        code: 'Новый',
        name: 'Неизвестный товар',
        stock: { 'ТВЗ': 0, 'Электромаркет': 0 },
        reserved: 0,
        location: 'Не указано',
        quantity: 0
      };
      setCurrentProduct(newProduct);
      addScannedItem(1);
    }
  };

  // Добавление товара в список
  const addScannedItem = (qty) => {
    if (!currentProduct) {
      alert('Сначала отсканируйте товар');
      return;
    }

    debugLog(`Добавление количества: ${qty} для товара ${currentProduct.name}`);

    const existingIndex = scannedItems.findIndex(item => item.barcode === currentProduct.barcode);
    let updatedItems = [...scannedItems];

    if (existingIndex !== -1) {
      updatedItems[existingIndex] = {
        ...updatedItems[existingIndex],
        quantity: updatedItems[existingIndex].quantity + qty
      };
    } else {
      updatedItems.push({
        id: currentProduct.id,
        code: currentProduct.code,
        barcode: currentProduct.barcode,
        name: currentProduct.name,
        quantity: qty,
        warehouse: selectedWarehouse,
        location: currentProduct.location
      });
    }

    setScannedItems(updatedItems);
    displayProductInfo(currentProduct);
    showNotification(`Добавлено ${qty} единиц товара "${currentProduct.name}"`);
  };

  // Отображение информации о товаре
  const displayProductInfo = (product) => {
    const quantity = getCurrentQuantity(product);
    setCurrentProduct({
      ...product,
      quantity: quantity
    });
  };

  // Получение текущего количества товара
  const getCurrentQuantity = (product) => {
    const item = scannedItems.find(i => i.barcode === product.barcode);
    return item ? item.quantity : 0;
  };

  // Добавление количества
  const addQuantity = () => {
    if (!currentProduct) {
      alert('Сначала отсканируйте товар');
      return;
    }

    if (quantity <= 0) {
      alert('Количество должно быть положительным числом');
      return;
    }

    if (isInEditMode) {
      const existingIndex = scannedItems.findIndex(item => item.barcode === currentProduct.barcode);
      if (existingIndex !== -1) {
        const updatedItems = [...scannedItems];
        updatedItems[existingIndex] = {
          ...updatedItems[existingIndex],
          quantity: quantity
        };
        setScannedItems(updatedItems);
        displayProductInfo(currentProduct);
        showNotification(`Количество товара "${currentProduct.name}" изменено на ${quantity}`);
        debugLog(`Товар отредактирован: ${currentProduct.name} → ${quantity}`);
      }
      setIsInEditMode(false);
      setCurrentProduct(null);
    } else {
      addScannedItem(quantity);
    }

    setQuantity(1);
    if (barcodeInputRef.current) {
      barcodeInputRef.current.focus();
    }
  };

  // Удаление товара
  const deleteItem = (barcode) => {
    const updatedItems = scannedItems.filter(item => item.barcode !== barcode);
    setScannedItems(updatedItems);
    
    if (currentProduct && currentProduct.barcode === barcode) {
      setCurrentProduct(null);
    }
    
    showNotification('Товар удален из списка');
    debugLog(`Товар удален: ${barcode}`);
  };

  // Редактирование товара
  const editItem = (barcode) => {
    const item = scannedItems.find(i => i.barcode === barcode);
    if (!item) return;

    const product = nomenclature.find(p => p.barcode === barcode) || item;
    setCurrentProduct(product);
    setQuantity(item.quantity);
    setIsInEditMode(true);
    setActiveTab('scan');
    
    showNotification(`Редактирование товара: ${product.name}`);
    debugLog(`Редактирование товара: ${barcode}`);
  };

  // Экспорт в CSV
  const exportToCSV = () => {
    if (scannedItems.length === 0) {
      alert('Нет данных для экспорта');
      return;
    }

    debugLog('Экспорт данных в CSV');
    const BOM = "\uFEFF";
    let csvContent = BOM + "Код;Наименование;Количество;Штрих-код;Склад;Расположение\n";
    
    scannedItems.forEach(item => {
      csvContent += `${item.code};"${item.name}";${item.quantity};${item.barcode};${item.warehouse};${item.location}\n`;
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    const date = new Date().toISOString().slice(0, 10);
    link.setAttribute("href", url);
    link.setAttribute("download", `инвентаризация_${date}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showNotification('Данные экспортированы в CSV');
  };

  // Экспорт через WebSocket
  const exportViaWebSocket = () => {
    if (!wsRef.current || wsRef.current.readyState !== WebSocket.OPEN) {
      const reconnect = confirm('Нет подключения к серверу. Попробовать переподключиться?');
      if (reconnect) {
        connectWebSocket();
        setTimeout(exportViaWebSocket, 1000);
      }
      debugLog('Попытка экспорта без активного WebSocket-соединения');
      return;
    }

    if (scannedItems.length === 0) {
      alert('Нет данных для экспорта');
      return;
    }

    debugLog('Подготовка данных для экспорта через WebSocket...');
    let i = 0;
    
    const sendNext = () => {
      if (i < scannedItems.length) {
        const item = scannedItems[i];
        const data = `${item.barcode}g${item.quantity}\n`;
        debugLog(`Отправка: ${data}`);
        
        try {
          wsRef.current.send(data);
          i++;
          setTimeout(sendNext, 100);
        } catch (err) {
          const errorMessage = err.message || 'Неизвестная ошибка сети';
          debugLog(`Ошибка WebSocket: ${errorMessage}`);
          alert(`Ошибка отправки через WebSocket:\n${errorMessage}\nПроверьте:\n1. Запущен ли WebSocket-сервер\n2. Доступен ли IP в сети`);
        }
      } else {
        debugLog('Все данные отправлены через WebSocket');
        showNotification('Данные успешно отправлены через WebSocket!');
      }
    };
    
    sendNext();
  };

  // Показ уведомления
  const showNotification = (message) => {
    const notification = document.createElement('div');
    notification.className = 'fixed top-20 right-4 bg-blue-500 text-white p-4 rounded-lg shadow-lg z-50 transition-opacity duration-300 opacity-0';
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.classList.remove('opacity-0');
      notification.classList.add('opacity-100');
    }, 10);
    
    setTimeout(() => {
      notification.classList.remove('opacity-100');
      notification.classList.add('opacity-0');
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 300);
    }, 3000);
    
    debugLog(`Показано уведомление: ${message}`);
  };

  // Обработчики событий
  const handleBarcodeKeyPress = (e) => {
    if (e.key === 'Enter') {
      processBarcode(e.target.value.trim());
      e.target.value = '';
    }
  };

  const handleQuantityKeyPress = (e) => {
    if (e.key === 'Enter') {
      addQuantity();
    }
  };

  // Проверка HTTPS при загрузке
  useEffect(() => {
    if (window.location.protocol === 'https:') {
      setShowHttpsWarning(true);
      setUseSecureProtocol(true);
    }
  }, []);

  // Автоматическое подключение при загрузке
  useEffect(() => {
    setTimeout(() => {
      if (serverIp) {
        connectWebSocket();
      }
    }, 1000);
  }, []);

  return (
    <div className="min-h-screen bg-gray-50 font-sans">
      {/* Навигация */}
      <nav className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 shadow-lg">
        <div className="container mx-auto flex items-center">
          <i className="fas fa-cubes mr-2 text-xl"></i>
          <span className="text-xl font-bold">Инвентаризация</span>
        </div>
      </nav>

      {/* Предупреждение о HTTPS */}
      {showHttpsWarning && (
        <div className="container mx-auto px-4 py-3 bg-yellow-100 text-yellow-800 rounded-lg mt-4 flex items-center">
          <i className="fas fa-exclamation-triangle mr-2"></i>
          <strong>Внимание:</strong> Страница загружена по HTTPS. Для работы с WebSocket используйте WSS (Secure WebSocket) или загрузите страницу по HTTP.
        </div>
      )}

      {/* Статус подключения */}
      <div className={`fixed top-20 right-4 px-3 py-2 rounded-full text-xs font-semibold z-50 ${
        connectionStatus === 'connected' ? 'bg-green-500 text-white' :
        connectionStatus === 'connecting' ? 'bg-yellow-500 text-white' :
        'bg-red-500 text-white'
      }`}>
        <i className={`fas ${connectionStatus === 'connected' ? 'fa-plug' : connectionStatus === 'connecting' ? 'fa-sync-alt' : 'fa-plug'} mr-1`}></i>
        {connectionStatus === 'connected' ? 'Подключено' : connectionStatus === 'connecting' ? 'Подключение...' : 'Нет подключения'}
      </div>

      <div className="container mx-auto px-4 py-6">
        {/* Главный экран */}
        {currentScreen === 'main' && (
          <div>
            {/* Тип инвентаризации */}
            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
              <h2 className="text-lg font-semibold mb-4">Тип инвентаризации</h2>
              <div className="space-y-3">
                <label className="flex items-center">
                  <input
                    type="radio"
                    name="inventoryType"
                    value="location"
                    checked={inventoryType === 'location'}
                    onChange={(e) => setInventoryType(e.target.value)}
                    className="mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300"
                  />
                  <span>По местам хранения</span>
                </label>
                <label className="flex items-center">
                  <input
                    type="radio"
                    name="inventoryType"
                    value="nomenclature"
                    checked={inventoryType === 'nomenclature'}
                    onChange={(e) => setInventoryType(e.target.value)}
                    className="mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300"
                  />
                  <span>По номенклатуре</span>
                </label>
              </div>
            </div>

            {/* Выбор склада */}
            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
              <h2 className="text-lg font-semibold mb-4">Выбор склада</h2>
              <select
                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                value={selectedWarehouse}
                onChange={(e) => setSelectedWarehouse(e.target.value)}
              >
                <option value="ТВЗ">Склад основного товара ТВЗ</option>
                <option value="Электромаркет">Склад Электромаркет</option>
              </select>
            </div>

            {/* Настройки подключения */}
            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
              <h2 className="text-lg font-semibold mb-4">Настройки подключения</h2>
              <div className="space-y-4">
                <div>
                  <label htmlFor="serverIp" className="block text-sm font-medium text-gray-700 mb-2">IP-адрес сервера</label>
                  <input
                    type="text"
                    id="serverIp"
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Введите IP-адрес сервера"
                    value={serverIp}
                    onChange={(e) => setServerIp(e.target.value)}
                  />
                </div>
                <div>
                  <label htmlFor="serverPort" className="block text-sm font-medium text-gray-700 mb-2">Порт сервера</label>
                  <input
                    type="number"
                    id="serverPort"
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    value={serverPort}
                    onChange={(e) => setServerPort(e.target.value)}
                  />
                </div>
                <div className="flex items-center">
                  <input
                    type="checkbox"
                    id="useSecureProtocol"
                    className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                    checked={useSecureProtocol}
                    onChange={(e) => setUseSecureProtocol(e.target.checked)}
                  />
                  <label htmlFor="useSecureProtocol" className="ml-2 block text-sm text-gray-700">
                    Использовать безопасное соединение (WSS)
                  </label>
                </div>
                <button
                  onClick={testConnection}
                  className="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center"
                >
                  <i className="fas fa-plug mr-2"></i>Проверить подключение
                </button>
              </div>
            </div>

            {/* Кнопка начала инвентаризации */}
            <div className="mb-6">
              <button
                onClick={startInventory}
                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg text-lg transition duration-200 flex items-center justify-center"
              >
                <i className="fas fa-play-circle mr-2"></i>Начать инвентаризацию
              </button>
            </div>

            {/* Тест совместимости */}
            <div className="bg-white rounded-lg shadow-md p-6">
              <h2 className="text-lg font-semibold mb-4">Тест совместимости</h2>
              <button
                onClick={testCompatibility}
                className="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center"
              >
                <i className="fas fa-check-circle mr-2"></i>Проверить совместимость
              </button>
              {compatibilityResults.length > 0 && (
                <div className="mt-4 p-4 bg-gray-100 rounded-lg">
                  <ul className="space-y-2">
                    {compatibilityResults.map((result, index) => (
                      <li key={index} className={result.includes('НЕ') ? 'text-red-600' : 'text-green-600'}>
                        {result}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Экран сканирования */}
        {currentScreen === 'scan' && (
          <div>
            {/* Вкладки */}
            <ul className="flex border-b mb-6">
              <li className="mr-2">
                <button
                  className={`py-3 px-4 font-medium rounded-t-lg transition-colors ${
                    activeTab === 'scan' 
                      ? 'bg-white text-blue-600 border-b-2 border-blue-600' 
                      : 'text-gray-500 hover:text-gray-700'
                  }`}
                  onClick={() => setActiveTab('scan')}
                >
                  <i className="fas fa-barcode mr-1"></i>Сканирование
                </button>
              </li>
              <li>
                <button
                  className={`py-3 px-4 font-medium rounded-t-lg transition-colors flex items-center ${
                    activeTab === 'scanned' 
                      ? 'bg-white text-blue-600 border-b-2 border-blue-600' 
                      : 'text-gray-500 hover:text-gray-700'
                  }`}
                  onClick={() => setActiveTab('scanned')}
                >
                  <i className="fas fa-list mr-1"></i>Отсканировано
                  <span className="ml-2 bg-purple-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
                    {scannedItems.length}
                  </span>
                </button>
              </li>
            </ul>

            {/* Вкладка сканирования */}
            {activeTab === 'scan' && (
              <div className="bg-white rounded-lg shadow-md p-6">
                <h2 className="text-lg font-semibold mb-4">Сканирование товара</h2>
                
                <div className="mb-4">
                  <label htmlFor="barcodeInput" className="block text-sm font-medium text-gray-700 mb-2">Штрих-код товара</label>
                  <input
                    ref={barcodeInputRef}
                    type="text"
                    id="barcodeInput"
                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Введите штрих-код"
                    onKeyPress={handleBarcodeKeyPress}
                    autoComplete="off"
                  />
                </div>
                
                <div className="mb-4">
                  <label htmlFor="quantityInput" className="block text-sm font-medium text-gray-700 mb-2">Добавить количество (по умолчанию +1)</label>
                  <div className="flex items-center">
                    <button
                      onClick={() => setQuantity(prev => Math.max(1, prev - 1))}
                      className="px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-l-lg transition-colors"
                    >
                      -
                    </button>
                    <input
                      type="number"
                      id="quantityInput"
                      className="w-full text-center p-3 border-t border-b border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      min="1"
                      value={quantity}
                      onChange={(e) => setQuantity(parseInt(e.target.value) || 1)}
                      onKeyPress={handleQuantityKeyPress}
                    />
                    <button
                      onClick={() => setQuantity(prev => prev + 1)}
                      className="px-4 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-r-lg transition-colors"
                    >
                      +
                    </button>
                  </div>
                </div>
                
                <button
                  onClick={addQuantity}
                  className="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center"
                >
                  <i className="fas fa-plus-circle mr-2"></i>Добавить количество
                </button>
                
                {currentProduct && (
                  <div className="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 className="font-semibold mb-3">Информация о товаре</h3>
                    <div className="space-y-2 text-sm">
                      <p><strong>Код:</strong> {currentProduct.code}</p>
                      <p><strong>Наименование:</strong> {currentProduct.name}</p>
                      <p><strong>Штрих-код:</strong> {currentProduct.barcode}</p>
                      <p><strong>Остаток на складе ({selectedWarehouse}):</strong> {currentProduct.stock ? currentProduct.stock[selectedWarehouse] : 0}</p>
                      <p><strong>Забронировано:</strong> {currentProduct.reserved}</p>
                      <p><strong>Место хранения:</strong> {currentProduct.location}</p>
                      <p><strong>Текущее количество:</strong> {getCurrentQuantity(currentProduct)}</p>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Вкладка отсканированного */}
            {activeTab === 'scanned' && (
              <div className="bg-white rounded-lg shadow-md">
                <div className="flex justify-between items-center p-6 border-b">
                  <h2 className="text-lg font-semibold">Отсканированные товары</h2>
                  <div>
                    <button
                      onClick={exportToCSV}
                      className="mr-2 bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded text-sm transition duration-200 flex items-center"
                    >
                      <i className="fas fa-file-export mr-1"></i>CSV
                    </button>
                    <button
                      onClick={exportViaWebSocket}
                      className="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded text-sm transition duration-200 flex items-center"
                    >
                      <i className="fas fa-plug mr-1"></i>Сервер
                    </button>
                  </div>
                </div>
                <div className="p-6">
                  {scannedItems.length === 0 ? (
                    <p className="text-center text-gray-500 mt-3">Нет отсканированных товаров</p>
                  ) : (
                    <div className="space-y-4">
                      {scannedItems.map((item) => (
                        <div key={item.barcode} className="border-l-4 border-blue-500 bg-white p-4 rounded">
                          <div className="flex justify-between items-start">
                            <div>
                              <h3 className="font-medium">{item.name}</h3>
                              <p className="text-gray-600 text-sm">Код: {item.code} | Штрих-код: {item.barcode}</p>
                              <p className="text-gray-800">Количество: <strong>{item.quantity}</strong></p>
                              <p className="text-gray-600 text-sm">Склад: {item.warehouse} | Расположение: {item.location}</p>
                            </div>
                            <div className="flex space-x-2">
                              <button
                                onClick={() => editItem(item.barcode)}
                                className="px-3 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded text-sm transition-colors"
                              >
                                <i className="fas fa-edit"></i>
                              </button>
                              <button
                                onClick={() => deleteItem(item.barcode)}
                                className="px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded text-sm transition-colors"
                              >
                                <i className="fas fa-trash"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Кнопка назад */}
            <button
              onClick={backToMain}
              className="fixed bottom-6 left-6 w-14 h-14 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg flex items-center justify-center text-2xl transition-colors"
              title="Назад"
            >
              <i className="fas fa-arrow-left"></i>
            </button>
          </div>
        )}
      </div>

      {/* Панель отладки */}
      <div className="fixed bottom-0 left-0 right-0 bg-red-100 text-red-800 p-3 text-xs z-50 overflow-auto max-h-24">
        <strong>Отладка:</strong> {debugMessage}
      </div>
    </div>
  );
};

export default App;
