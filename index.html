<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Инвентаризация</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  input, button { font-size: 1em; padding: 6px; margin: 5px 0; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  #scannerContainer { width: 100%; max-width: 400px; height: 300px; border: 1px solid #ccc; margin-top: 10px; }
  .debug-info { margin-top: 10px; font-size: 0.9em; color: #666; }
</style>
</head>
<body>
<h2>Инвентаризация</h2>

<label for="barcodeInput">Ввод ШК или сканирование:</label><br/>
<input id="barcodeInput" type="text" placeholder="Введите или отсканируйте штрихкод" autofocus />
<button id="addQtyBtn">Добавить количество к последнему</button>
<input id="qtyToAdd" type="number" value="1" min="1" style="width: 60px;" />

<table>
  <thead>
    <tr><th>Штрихкод</th><th>Количество</th><th>Редактировать</th></tr>
  </thead>
  <tbody id="itemsTableBody"></tbody>
</table>

<button id="exportCsvBtn">Экспорт в CSV</button>
<button id="sendBluetoothBtn">Отправить по Bluetooth</button>

<hr>

<h3>Сканирование камеры</h3>
<button id="startScan">Начать сканирование</button>
<button id="stopScan" disabled>Остановить сканирование</button>
<button id="switchCamera">Переключить камеру</button>
<div id="scannerContainer"></div>
<div id="debugInfo" class="debug-info"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script>
let items = [];
let lastScanned = null;
let isScanning = false;
let scanPaused = false;
let currentFacingMode = "environment";

function saveItems() {
  localStorage.setItem('inventoryItems', JSON.stringify(items));
}

function loadItems() {
  const saved = localStorage.getItem('inventoryItems');
  if (saved) {
    try {
      items = JSON.parse(saved);
      refreshTable();
    } catch(e) {
      console.error('Ошибка парсинга данных из localStorage', e);
    }
  }
}

function refreshTable() {
  const tbody = document.getElementById('itemsTableBody');
  tbody.innerHTML = '';
  items.forEach((item, index) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.code}</td>
      <td><input type="number" min="1" value="${item.qty}" data-index="${index}" class="editQty" /></td>
      <td><button data-index="${index}" class="deleteBtn">Удалить</button></td>
    `;
    tbody.appendChild(tr);
  });

  document.querySelectorAll('.editQty').forEach(input => {
    input.addEventListener('change', e => {
      const i = e.target.dataset.index;
      const val = parseInt(e.target.value);
      if(val > 0) {
        items[i].qty = val;
        saveItems();
      }
      refreshTable();
    });
  });

  document.querySelectorAll('.deleteBtn').forEach(btn => {
    btn.addEventListener('click', e => {
      const i = e.target.dataset.index;
      items.splice(i, 1);
      saveItems();
      refreshTable();
    });
  });
}

function addOrIncreaseItem(code, qty = 1) {
  if (!code) return;
  let existing = items.find(item => item.code === code);
  if(existing) {
    existing.qty += qty;
  } else {
    items.push({code: code, qty: qty});
  }
  lastScanned = code;
  saveItems();
  refreshTable();
}

document.getElementById('barcodeInput').addEventListener('keydown', function(e) {
  if(e.key === 'Enter') {
    const code = e.target.value.trim();
    if(!code) return;
    addOrIncreaseItem(code, 1);
    e.target.value = '';
  }
});

document.getElementById('addQtyBtn').addEventListener('click', () => {
  if(lastScanned) {
    const qty = parseInt(document.getElementById('qtyToAdd').value);
    if(qty > 0) {
      addOrIncreaseItem(lastScanned, qty);
    }
  } else {
    alert('Нет последнего отсканированного кода');
  }
});

document.getElementById('exportCsvBtn').addEventListener('click', () => {
  let csvContent = '';
  items.forEach(i => {
    csvContent += `${i.code}h${i.qty}\n`;
  });
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'inventory.csv';
  a.click();
  URL.revokeObjectURL(url);
});

async function sendOverBluetooth() {
  if (!navigator.bluetooth) {
    alert('Bluetooth не поддерживается в этом браузере');
    return;
  }
  try {
    const device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: ['00001101-0000-1000-8000-00805f9b34fb']
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService('00001101-0000-1000-8000-00805f9b34fb');
    const characteristic = await service.getCharacteristic('00001101-0000-1000-8000-00805f9b34fb');

    let csvContent = '';
    items.forEach(i => {
      csvContent += `${i.code}h${i.qty}\n`;
    });
    const encoder = new TextEncoder();
    const data = encoder.encode(csvContent);

    await characteristic.writeValue(data);
    alert('Данные отправлены по Bluetooth!');
  } catch (error) {
    console.error(error);
    alert('Ошибка Bluetooth: ' + error);
  }
}

document.getElementById('sendBluetoothBtn').addEventListener('click', sendOverBluetooth);

const startScanBtn = document.getElementById('startScan');
const stopScanBtn = document.getElementById('stopScan');
const switchCameraBtn = document.getElementById('switchCamera');
const scannerContainer = document.getElementById('scannerContainer');
const debugInfo = document.getElementById('debugInfo');

function updateDebugInfo(message) {
  debugInfo.textContent = message;
  console.log(message);
}

function startScanner() {
  if (isScanning) return;
  
  updateDebugInfo("Инициализация сканера...");
  
  // Более простая и надежная конфигурация
  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: scannerContainer,
      constraints: {
        facingMode: currentFacingMode,
        width: 640,
        height: 480
      }
    },
    decoder: {
      readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader"]
    },
    locator: {
      patchSize: "medium",
      halfSample: true
    },
    locate: true,
    numOfWorkers: 2,
    frequency: 10,
    debug: {
      drawBoundingBox: true,
      showPattern: true
    }
  }, function(err) {
    if (err) {
      updateDebugInfo("Ошибка инициализации: " + err);
      alert('Не удалось запустить камеру. Попробуйте другой браузер (Chrome, Edge) или проверьте разрешения.');
      return;
    }
    
    Quagga.start();
    isScanning = true;
    scanPaused = false;
    startScanBtn.disabled = true;
    stopScanBtn.disabled = false;
    startScanBtn.textContent = 'Сканирование...';
    updateDebugInfo("Сканер запущен. Наведите камеру на штрихкод.");
  });

  Quagga.onProcessed(function(result) {
    if (!result) return;
    
    // Отладочная информация о процессе сканирования
    if (result.boxes) {
      const canvas = Quagga.canvas.dom.overlay;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, parseInt(canvas.width), parseInt(canvas.height));
      
      if (result.boxes) {
        result.boxes.filter(function(box) {
          return box !== result.box;
        }).forEach(function(box) {
          Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, ctx, {color: "green", lineWidth: 2});
        });
      }
      
      if (result.box) {
        Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, ctx, {color: "#00F", lineWidth: 2});
      }
      
      if (result.codeResult && result.codeResult.code) {
        Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, ctx, {color: 'red', lineWidth: 3});
      }
    }
  });

  Quagga.onDetected(function(result) {
    if (!result || !result.codeResult || !result.codeResult.code) return;
    if (scanPaused) return;

    const code = result.codeResult.code.trim();
    const confidence = result.codeResult.confidence || 0;
    
    if (!code) return;

    updateDebugInfo(`Распознан код: "${code}", уверенность: ${confidence.toFixed(2)}`);

    // Улучшенная валидация штрихкода
    if (code.length < 4) {
      updateDebugInfo("Слишком короткий код, пропускаем");
      return;
    }
    
    // Проверяем уверенность распознавания
    if (confidence < 20) {
      updateDebugInfo("Низкая уверенность распознавания, пропускаем");
      return;
    }
    
    // Проверяем на наличие только допустимых символов
    if (!/^[0-9a-zA-Z\-\.\s]+$/.test(code)) {
      updateDebugInfo("Код содержит недопустимые символы");
      return;
    }

    // Добавляем код с количеством 1
    addOrIncreaseItem(code, 1);
    updateDebugInfo(`✅ Добавлен штрихкод: ${code}`);

    // Устанавливаем паузу на 1.5 секунды
    scanPaused = true;
    setTimeout(() => {
      scanPaused = false;
      updateDebugInfo("Готов к сканированию следующего штрихкода");
    }, 1500);

    // Визуальная обратная связь
    startScanBtn.textContent = '✅ Сканировано';
    setTimeout(() => {
      if (isScanning) {
        startScanBtn.textContent = 'Сканирование...';
      }
    }, 1500);
  });
}

startScanBtn.addEventListener('click', startScanner);

stopScanBtn.addEventListener('click', () => {
  if (!isScanning) return;
  
  Quagga.stop();
  scannerContainer.innerHTML = '';
  isScanning = false;
  scanPaused = false;
  startScanBtn.disabled = false;
  stopScanBtn.disabled = true;
  startScanBtn.textContent = 'Начать сканирование';
  updateDebugInfo("Сканирование остановлено");
});

switchCameraBtn.addEventListener('click', () => {
  if (isScanning) {
    Quagga.stop();
    isScanning = false;
  }
  
  // Переключаем между фронтальной и задней камерой
  currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
  
  updateDebugInfo(`Переключение на камеру: ${currentFacingMode === "environment" ? "задняя" : "фронтальная"}`);
  
  // Перезапускаем сканер с новой камерой
  setTimeout(startScanner, 500);
});

loadItems();

</script>
</body>
</html>
